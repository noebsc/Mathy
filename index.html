<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Mathy by No√©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --beige: #f8f2e7;
      --beige2: #efe0cd;
      --brique: #cb9161;
      --accent: #af6a3a;
      --accent2: #e8b183;
      --text: #3c2a17;
      --border: #e0c6b0;
      --bg-btn: #fff9f2;
      --success: #4be37b;
      --error: #ff8585;
      --radius: 18px;
      --shadow: 0 6px 40px #dbc4a630, 0 2px 7px #f7e4c999;
      --transition: .22s cubic-bezier(.40,.48,.39,.94);
      --transition-btn: .19s cubic-bezier(.54,.17,.20,1.23);
    }
    body {
      background: linear-gradient(125deg, var(--beige) 80%, var(--brique) 220%);
      min-height: 100vh; margin: 0;
      font-family: 'Inter', system-ui, Arial, sans-serif;
      color: var(--text);
      letter-spacing: 0.01em;
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      background: var(--beige2);border-bottom:1px solid var(--border);
      padding: 14px 3vw 13px 3vw; min-height:54px;
    }
    .header-left {
      display: flex; align-items: center; gap: 23px;
    }
    .burger {
      width: 46px;height: 46px;display:flex;align-items:center;cursor:pointer;
      background:var(--beige);border-radius:50%;justify-content:center;
      border:2px solid var(--border);transition:box-shadow var(--transition);
      box-shadow:0 4px 15px #c8ac8c22;
    }
    .burger span, .burger span:before, .burger span:after {
      content:'';display:block;height:4px;width:26px;border-radius:2px;background:var(--accent);
      position:relative;transition:var(--transition);
    }
    .burger span:before{content:"";position:absolute;top:-8px;}
    .burger span:after{content:"";position:absolute;top:8px;}
    .burger.open span{background:transparent;}
    .burger.open span:before{top:0;transform:rotate(45deg);}
    .burger.open span:after{top:0;transform:rotate(-45deg);}
    .title-mathy {
      font-weight: 800; font-size: 1.85rem; color: var(--accent);
      letter-spacing: 0.05em;
    }
    .by-noe {
      font-size: 1rem; color: #987155;margin-left:7px;
      font-weight: 400;opacity:.83;
    }
    nav.sidebar {
      position:fixed;top:0;left:-265px;height:100vh;width:220px;z-index:11;
      background:var(--beige2);
      border-right:1.8px solid var(--border);
      display:flex;flex-direction:column;gap:18px;padding-top:65px;
      box-shadow:0 0 56px #ae724a20;
      transition:left var(--transition);
    }
    nav.sidebar.open { left:0; }
    nav.sidebar button {
      border:none;background:none;
      color:var(--accent);font:700 1.18rem 'Inter',sans-serif;padding:15px 22px;
      border-radius: var(--radius);
      transition: 
        background var(--transition-btn), color var(--transition-btn),
        transform var(--transition-btn), box-shadow var(--transition-btn);
      margin-right:10px;cursor:pointer;
      margin-bottom:2px;
      outline:none;
    }
    nav.sidebar button.active,
    nav.sidebar button:hover {
      background: linear-gradient(95deg, var(--accent2) 60%, var(--brique) 180%);
      color:#fff;
      transform:translateX(7px) scale(1.08);
      box-shadow:0 1px 8px #c06c2e15;
    }
    nav.sidebar button[data-page]{font-size:1.13rem;}
    nav.sidebar button.logout {margin-top:auto;background:#fff1e0;color:#c7420b;font-size:1.05rem;border:2px solid #c7420b;}
    /* -------- Layout -------- */
    main.content {margin:34px auto 32px auto;min-height:60vh;max-width:970px;}
    @media (max-width:700px){main.content{margin:24px 3vw;}}
    .fade { animation:fade .18s linear; }
    @keyframes fade { from {opacity:0;transform:translateY(16px);}to{opacity:1;transform:translateY(0);} }
    /* -------- Modern BUTTONS -------- */
    .btn, button.save-btn, button.main-btn, button.mode-btn, button.quiz-btn {
      border: none;
      outline: none;
      background: linear-gradient(95deg,var(--beige2),var(--beige));
      color: var(--accent);
      padding: 15px 36px;
      font-size: 1.22rem;
      border-radius: var(--radius);
      font-weight: 700;
      box-shadow: 0 3px 13px #d3b68527;
      cursor: pointer;
      transition: 
        background .24s cubic-bezier(.4,.8,.3,1.1),
        color .2s,box-shadow .15s, transform .17s cubic-bezier(.25,.9,.27,1.02)
      ;
      margin:9px 12px 14px 0; 
      margin-bottom:16px;
      min-width:145px;
    }
    .btn:active, button.save-btn:active, button.main-btn:active, button.mode-btn:active, button.quiz-btn:active {
      transform:scale(.96);
      background:var(--accent2);
      color:#fff;
    }
    .btn:hover,button.save-btn:hover,button.main-btn:hover,button.mode-btn:hover,button.quiz-btn:hover {
      background: linear-gradient(100deg, var(--brique) 70%, var(--accent2));
      color:#fff;box-shadow:0 8px 31px #cb916135;
    }
    /* -------- TABLES -------- */
    .tables-grid {
      display:grid;grid-template-columns:repeat(auto-fit,minmax(158px,1fr));gap:25px;margin:27px 0 0 0;
    }
    .table-multi {
      border:2.5px solid var(--border);border-radius:var(--radius);padding:13px 8px 8px 8px;
      background:#fff;box-shadow:var(--shadow);transition:transform .15s,border .15s,background .15s;
      cursor:pointer;text-align:center;font-size:1.15rem;
    }
    .table-multi.selected,.table-multi:hover {
      border:2.5px solid var(--accent);background:linear-gradient(110deg,#fffefb,#f3dec1 98%);
      transform:scale(1.036);
    }
    /* Zoom Table */
    .zoom-table-bg {
      position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.14);
      z-index:21;display:flex;align-items:center;justify-content:center;
      backdrop-filter:blur(2px);
      animation:fade .14s;
    }
    .zoom-table {
      background:#fff;border-radius:28px;box-shadow:0 8px 42px #b4854b33;
      padding:38px 56px;font-size:1.21rem;max-width:96vw;min-width:200px;
      border:2.5px solid var(--accent); text-align:center;
    }
    /* -------- QUIZ TABLE SELECT -------- */
    .quiz-select {display:flex;flex-wrap:wrap;gap:11px;margin:20px 0 10px 0;}
    .select-table {
      padding:7px 21px 7px 9px;border-radius:var(--radius);font-weight:600;
      border:2px solid var(--border);
      background:var(--bg-btn);cursor:pointer;
      font-size:1.08rem;transition:background .14s,border .17s;
      display:flex;align-items:center;gap:9px;color:var(--accent);user-select:none;
    }
    .select-table.selected{
      background:linear-gradient(110deg,var(--brique) 40%,var(--accent2) 120%);
      color:#fff;border:2.2px solid var(--accent);
      transform:scale(1.06);
    }
    .select-table input[type="checkbox"]{accent-color:var(--accent);}
    /* -------- ProgressBar -------- */
    .progress-bar {
      height:14px;background:#ecd4ae;border-radius:8px;width:310px;max-width:99vw;overflow:hidden;margin:0 auto 14px auto;
      border:1.5px solid var(--brique);
      box-shadow:0 2px 10px #e4bc7b3a inset;
    }
    .bar-inner {background:linear-gradient(90deg,var(--accent),var(--brique));height:100%;width:100%;transition:width .052s;}
    /* -------- QUIZ/AUTRES -------- */
    .quiz-input {font-size:1.42rem;padding:9px 17px;width:110px;margin:7px;border-radius:12px;border:1.7px solid var(--border);}
    .blanks-grid {
      display:grid;grid-template-columns:repeat(4,1fr);gap:13px;margin-top:23px;background:#fff;border-radius:18px;padding:22px 10px 12px 10px;
      border:2px solid var(--border); box-shadow:var(--shadow);
    }
    @media (max-width:780px){.blanks-grid{grid-template-columns:repeat(2,1fr);}}
    .blank-box {font-size:1.08rem;}
    .blank-answer {
      width:60px;font-size:1.18rem;text-align:center;margin:0 4px 0 0;
      border:1.6px solid #dfbc9f;border-radius:12px;padding:5px 2px;outline:none;
      transition:background .13s,border .15s;
    }
    .blank-correct{background:#d6f7e2;border:1.7px solid #2ba865;}
    .blank-wrong{background:#fae8e4;border:1.8px solid #cb3d26;}
    .correction-row {font-size:1.01rem;color:var(--accent);}
    /* -------- MODE CARTES -------- */
    .card-zone {margin-top:40px;display:flex;flex-direction:column;align-items:center;}
    .card3D {height:150px;width:290px;display:flex;align-items:center;justify-content:center;
      border-radius:24px;background:#fff;font-size:2.16rem;color:var(--accent);
      border:2.5px solid var(--accent);box-shadow:0 8px 32px #b4854b14;
      cursor:pointer;perspective:900px; position:relative; transition: box-shadow .12s;
      margin-bottom:22px;
      font-family:'Inter',sans-serif; user-select:none;}
    .card-flip-side {position:absolute;top:0;left:0;width:100%;height:100%;backface-visibility:hidden;display:flex;flex-direction:column;align-items:center;justify-content:center;}
    .card-flip-front {z-index:1;}
    .card-flip-back {z-index:2;transform:rotateY(180deg);}
    .card3D.flipped {animation: cardFlipA .3s cubic-bezier(.59,-.06,.37,1.23) both;}
    @keyframes cardFlipA {
      0%{transform:rotateY(0);}
      100%{transform:rotateY(180deg);}
    }
    .card3D .card-flip-side {
      font-size:2.16rem;color:var(--accent);
      background:#fff;border-radius:inherit;width:100%;height:100%;
      display:flex;align-items:center;justify-content:center;
      transition:color .13s;
    }
    .card-flip-back {color:#fff;background:linear-gradient(93deg,var(--brique) 70%,var(--accent));}
    .card-arrows {display:flex;gap:28px;margin-top:18px;}
    .card-arrows button{
      font-size:1.52rem;padding:13px 31px;
      background:linear-gradient(104deg,var(--accent2),var(--brique));
      color:#fff;border:none;border-radius:var(--radius);cursor:pointer;font-weight:700;box-shadow:0 3px 10px #ad7c5420;
      transition:background .19s, color .143s, transform .13s;}
    .card-arrows button:active{background:var(--accent);}
    .card-arrows button:disabled{background:#e0c0a6;color:#cb9161;}
    /* -------- MODES LUDIQUES --------- */
    .modes-flex {display:flex;flex-wrap:wrap;gap:18px;margin:12px 0 18px 0;}
    .mode-btn {
      min-width:180px;max-width:97vw;
      background:linear-gradient(105deg,var(--beige2),var(--beige));
      color:var(--accent);border-radius:var(--radius);
      font-weight:700;font-size:1.19rem;padding:14px 22px;margin:0 6px 6px 0;
      border:2px solid var(--border);
      cursor:pointer;transition:background .19s,border .17s,color .17s,transform .16s;
    }
    .mode-btn:hover{background:linear-gradient(95deg,var(--brique) 70%,var(--accent2));color:#fff;border:2.5px solid var(--accent);}
    /* -------- Suivi -------- */
    .main-stats{display:flex;flex-wrap:wrap;gap:32px 18px;margin-top:18px;}
    .stat-block {background:#fff;border-radius:18px;box-shadow:var(--shadow);padding:22px 34px;flex:1 1 225px;}
    .stat-block .num{color:var(--accent);font-weight:bold;font-size:1.85rem;}
    .stat-title{font-size:1.11rem;margin-bottom:7px;}
    .suivi-table {width:100%;border-collapse:collapse;}
    .suivi-table th, .suivi-table td {padding:9px 14px;text-align:center;font-size:1.08rem;}
    .suivi-table th {background:var(--beige2);}
    .suivi-table td {background:#fff;}
    /* -------- Param√®tres -------- */
    .param-form {max-width:420px;margin:0 auto;}
    .param-form input[type="text"]{width:99%;padding:13px 14px;font-size:1.08rem;margin-bottom:18px;border:1.7px solid #d0b19b;border-radius:var(--radius);}
    .param-btns{display:flex;gap:14px;justify-content:space-between;margin-top:16px;}
    .reset-btn {
      background:#fff;color:#cb3d26;padding:14px 28px;border:2px solid #cb3d26;
      border-radius:var(--radius);cursor:pointer;font-weight:700;transition:background .14s, color .14s;
    }
    .reset-btn:hover{background:#cb3d26;color:#fff;}
    .save-btn{background:linear-gradient(98deg,var(--accent2) 67%,var(--brique));
      color:#fff; font-weight:700;border:none;box-shadow:0 4px 20px #cfa7753d;}
    .save-btn:hover{background:linear-gradient(100deg,var(--brique),var(--accent2));}
    .confirm-layer{
      position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.19);
      display:flex;align-items:center;justify-content:center;z-index:51;
    }
    .confirm-box{
      background:#fff;padding:38px 56px;border-radius:18px;box-shadow:0 17px 90px #ad957570;
      text-align:center;min-width:220px;
    }
    .confirm-box button{margin:10px 32px 0 32px;}
    .hidden {display:none;}
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <div class="burger" id="burger"><span></span></div>
      <span class="title-mathy">Mathy</span>
      <span class="by-noe">by No√©</span>
    </div>
  </header>
  <nav class="sidebar" id="sidebar">
    <button data-page="tables" class="active">Tables</button>
    <button data-page="apprentissage">Apprentissage</button>
    <button data-page="suivi">Suivi</button>
    <button data-page="parametres">Param√®tres</button>
    <button class="logout" id="logoutBtn">D√©connexion</button>
  </nav>
  <main class="content fade" id="content"></main>
  <div id="confirmLayer" class="hidden"></div>
  <div id="authModal" style="position:fixed;z-index:1000;top:0;left:0;right:0;bottom:0; background:#f8f3e5;display:flex;align-items:center;justify-content:center;">
    <form id="authForm" style="background:#fff;padding:37px 34px;border-radius:14px;box-shadow:0 8px 35px #bca57e32;display:flex;flex-direction:column;gap:19px;min-width:250px;">
      <h2 style="font-size:1.22rem;color:var(--accent);margin-bottom:7px;">Connexion √† Mathy</h2>
      <input type="email" id="email" placeholder="Adresse e-mail" required autocomplete="email" style="font-size:1.03rem;padding:10px 7px;border-radius:10px;border:1.6px solid #e0c6b0;">
      <input type="password" id="password" placeholder="Mot de passe" required autocomplete="current-password" style="font-size:1.03rem;padding:10px 7px;border-radius:10px;border:1.6px solid #e0c6b0;">
      <button class="btn" type="submit">Se connecter</button>
      <div style="font-size:.98rem;text-align:center;">Pas encore inscrit‚ÄØ? <span id="registerLink" style="color:var(--accent);cursor:pointer;text-decoration:underline;">Cr√©er un compte</span></div>
      <div style="color:#d01f1f;font-size:1rem;" id="authError"></div>
    </form>
  </div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getDatabase, ref, set, get, update } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
const firebaseConfig = {
  apiKey: "AIzaSyAz4RmoInpNHsjCMHM6tMdv1SWgUEB7ZyI",
  authDomain: "mathy-f7fc0.firebaseapp.com",
  databaseURL: "https://mathy-f7fc0-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "mathy-f7fc0",
  storageBucket: "mathy-f7fc0.appspot.com",
  messagingSenderId: "612107190361",
  appId: "1:612107190361:web:4b8c56d142372fc100f148",
  measurementId: "G-RQYNBK3BDE"
};
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth(app);
const db = getDatabase(app);

// -------- UI NAVIGATION --------
const burger = document.getElementById("burger"), sidebar = document.getElementById("sidebar"), content = document.getElementById("content");
burger.onclick = () => { burger.classList.toggle('open'); sidebar.classList.toggle('open'); }
document.body.addEventListener("mousedown", e=>{
  if (sidebar.classList.contains('open') && !sidebar.contains(e.target) && !burger.contains(e.target)) {
    burger.classList.remove('open'); sidebar.classList.remove('open');
  }
});
sidebar.querySelectorAll("button[data-page]").forEach(btn => {
  btn.onclick = () => switchPage(btn.dataset.page, btn);
});
let currentPage = "tables";
function switchPage(page, btn){
  sidebar.querySelectorAll("button[data-page]").forEach(b=>b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  currentPage = page;
  content.classList.remove("fade");
  setTimeout(()=>{ renderPage(page); content.classList.add("fade"); }, 25);
  if(window.innerWidth<740){ burger.classList.remove('open'); sidebar.classList.remove('open'); }
}

// ======= AUTH =======
const authModal = document.getElementById("authModal");
const authForm = document.getElementById("authForm");
const emailInput = document.getElementById("email");
const pwInput = document.getElementById("password");
const authError = document.getElementById("authError");
const registerLink = document.getElementById("registerLink");
let isRegisterMode = false;
registerLink.onclick = ()=>{
  isRegisterMode = !isRegisterMode;
  authForm.querySelector("button[type='submit']").innerText = isRegisterMode ? "Cr√©er un compte" : "Se connecter";
  registerLink.innerText = isRegisterMode ? "D√©j√† inscrit ? Se connecter" : "Cr√©er un compte";
};
authForm.onsubmit = async (e)=>{
  e.preventDefault();
  authError.innerText = "";
  try{
    if(isRegisterMode){
      await createUserWithEmailAndPassword(auth, emailInput.value, pwInput.value);
      await set(ref(db,'settings/'+auth.currentUser.uid), { userName:emailInput.value.split("@")[0] });
    } else {
      await signInWithEmailAndPassword(auth, emailInput.value, pwInput.value);
    }
  } catch(err){ authError.innerText = err.message; }
}
onAuthStateChanged(auth, user=>{
  if (user) { authModal.style.display = "none"; renderPage(currentPage);}
  else {authModal.style.display = "flex"; content.innerHTML = "";}
});
document.getElementById("logoutBtn").onclick = ()=>{ signOut(auth); }

// ======= Pages =======
function renderPage(page){
  if (page==="tables") renderTables();
  else if (page==="apprentissage") renderApprentissage();
  else if (page==="suivi") renderSuivi();
  else if (page==="parametres") renderParametres();
}

// ---------- TABLES ----------
function renderTables(){
  let html = `<h1 style="font-size:1.4rem;color:var(--accent);margin:0 0 10px 0;font-weight:800;">Tables de multiplication</h1>
    <div class="tables-grid">`;
  for(let t=1;t<=12;t++){
    html+=`<div class="table-multi" onclick="window.showTableZoom(${t})" id="t${t}">
      <div style="font-weight:700;color:var(--accent);font-size:1.12rem;">Table de ${t}</div>
      <div>`;
    for(let i=1;i<=12;i++){ html += `<div>${t} √ó ${i} = <b>${t*i}</b></div>`;}
    html+=`</div></div>`;
  }
  html+=`</div>`;
  content.innerHTML = html;
}
window.showTableZoom = function(n){
  const overlay=document.createElement('div');
  overlay.className='zoom-table-bg';
  overlay.onclick=e=>{if(e.target===overlay)overlay.remove();}
  let html = `<div class="zoom-table"><h2 style="color:var(--accent);font-size:1.35rem;font-weight:700;margin:0 0 10px 0;">Table de ${n}</h2>`;
  for(let i=1;i<=12;i++) html+=`<div>${n} √ó ${i} = <b>${n*i}</b></div>`;
  html+=`</div>`;
  overlay.innerHTML=html;document.body.appendChild(overlay);
}

// ---------- APPRENTISSAGE / MODES ----------
function renderApprentissage(){
  content.innerHTML=`
    <h1 style="font-size:1.27rem;color:var(--accent);font-weight:800;">Apprentissage</h1>
    <div class="modes-flex">
      <button class="mode-btn" onclick="window.selectQuizTables()">Quiz</button>
      <button class="mode-btn" onclick="window.renderBlanksQuiz()">Tables √† trou</button>
      <button class="mode-btn" onclick="window.renderCardMode()">Mode cartes</button>
      <button class="mode-btn" onclick="window.renderDefiRapide()">D√©fi rapide</button>
    </div>
    <div id="apprZone"></div>
  `;
}
window.selectQuizTables = function(){
  let tables = '';
  for(let i=1;i<=12;i++)
    tables += `<label class="select-table" id="qsel${i}" onclick="event.preventDefault();window.toggleQuizTable(${i})">
      <input type="checkbox" id="ch${i}" value="${i}" checked style="pointer-events:none;"> ${i}
    </label>`;
  document.getElementById('apprZone').innerHTML = `
    <div><b>Choisis les tables √† travailler :</b></div>
    <div class="quiz-select">${tables}</div>
    <button onclick="window.startQuiz()" class="main-btn">D√©marrer le quiz</button>
    <button onclick="renderApprentissage()" class="btn">Retour</button>
  `;
  window.selectedQuizTables = Array(12).fill(true);
}
window.toggleQuizTable = function(n){
  window.selectedQuizTables[n-1] = !window.selectedQuizTables[n-1];
  document.getElementById('ch'+n).checked = window.selectedQuizTables[n-1];
  let elem=document.getElementById('qsel'+n);
  if(window.selectedQuizTables[n-1]) elem.classList.add('selected');
  else elem.classList.remove('selected');
}
window.startQuiz = function(){
  let arr=[];for(let i=1;i<=12;i++)if(window.selectedQuizTables[i-1])for(let j=1;j<=12;j++)arr.push([i,j]);
  if(arr.length===0){alert("S√©lectionne au moins une table.");return;}
  arr.sort(()=>Math.random()-.5);
  window.quizData = arr; window.quizIndex=0; window.quizResults=[]; nextQuiz();
}
function nextQuiz(){
  if(window.quizIndex>=window.quizData.length) return finishQuiz();
  let [a,b]=window.quizData[window.quizIndex];
  let apprZone = document.getElementById('apprZone');
  apprZone.innerHTML=`<div style="text-align:center;margin:0 auto;">
    <div class="progress-bar"><div class="bar-inner" id="qtimer"></div></div>
    <div style="margin:15px 0 7px 0; font-size:1.66rem;font-weight:bold;">${a} √ó ${b}</div>
    <input class="quiz-input" id="quizAnswer" autocomplete="off" type="number" />
    <div>
      <button class="main-btn" onclick="window.submitQuizAnswer()">Valider</button>
      <button class="btn" onclick="renderApprentissage()">Retour</button>
    </div>
  </div>`;
  animateBar(10,30,()=>window.submitQuizAnswer(true)); // barre ultra fluide
  setTimeout(()=>{document.getElementById('quizAnswer').focus();},100);
}
function animateBar(sec,interval,callback){
  const bar=document.getElementById('qtimer');
  let elapsed=0, total=sec*1000, step = interval;
  function update(){
    elapsed+=step;
    let w = Math.max(100*(1-elapsed/total),0);
    bar.style.width = w + '%';
    if(elapsed<total) window.qBarTimer = setTimeout(update,step);
    else callback();
  }
  update();
}
window.submitQuizAnswer = function(timeout){
  clearTimeout(window.qBarTimer);
  const val = +document.getElementById("quizAnswer").value;
  let [a,b] = window.quizData[window.quizIndex];
  window.quizResults.push({q: [a,b], a: val, ok: val===a*b, timeout});
  window.quizIndex++; nextQuiz();
}
function finishQuiz(){
  // Save and display results
  let results = window.quizResults;
  let ok=results.filter(x=>x.ok&&!x.timeout).length,total=results.length;
  let timeouts=results.filter(x=>x.timeout).length;
  saveQuizToDB(results);
  document.getElementById('apprZone').innerHTML = `
    <div style="text-align:center;margin-top:29px;">
      <div style="font-size:1.32rem;margin-bottom:16px;color:var(--accent);font-weight:700;">
        R√©sultat : <b>${ok} / ${total}</b>
      </div>
      <div style="font-size:1.06rem;">Questions hors temps‚ÄØ: <b>${timeouts}</b></div>
      <button class="main-btn" onclick="renderApprentissage()">Retour</button>
    </div>
  `;
}
function saveQuizToDB(results){
  const uid = auth.currentUser.uid;
  const quiz = { results, date: Date.now() };
  const refQ = ref(db, 'quizz/'+uid+'/');
  get(refQ).then(snapshot=>{
    let arr = snapshot.exists() ? snapshot.val() : [];
    arr=Array.isArray(arr)?arr:[]; arr.push(quiz); set(refQ, arr);
  });
}

// --------- MODE TROUS -----------
window.renderBlanksQuiz = function(){
  let qs=[], answers=[], pos=0;
  for(let t=1;t<=12;t++)for(let i=1;i<=12;i++)qs.push({t,i, blank:Math.random()<.37 });
  qs = qs.sort(()=>Math.random()-.5);
  document.getElementById('apprZone').innerHTML = `
    <form id="blankQuizForm">
    <div><b>Compl√®te les cases manquantes‚ÄØ:</b></div>
    <div class="blanks-grid" id="blanksGrid">
    ${qs.map((q,j)=>q.blank?
      `<span class="blank-box">${q.t} √ó ${q.i} = <input type="number" class="blank-answer" id="bq${j}" data-resp="${q.t*q.i}" required autocomplete="off"></span>`
      : `<span class="blank-box">${q.t} √ó ${q.i} = <b>${q.t*q.i}</b></span>`
    ).join("")}
    </div>
    <button class="main-btn" type="submit" style="margin:18px auto 0 auto;display:block;">V√©rifier</button>
    <button class="btn" type="button" onclick="renderApprentissage()" style="margin-block:12px 0;">Retour</button>
    </form>
  `;
  document.getElementById("blankQuizForm").onsubmit=(e)=>{
    e.preventDefault();
    let good=0, bad=0, total=0;
    let inputs = Array.from(document.querySelectorAll(".blank-answer"));
    for(let inp of inputs){
      total++;
      if(+inp.value==+inp.dataset.resp){inp.classList.add("blank-correct");good++;}
      else {inp.classList.add("blank-wrong");bad++;}
      inp.disabled=true;
    }
    let corr = document.createElement("div");
    corr.className="correction-row";
    corr.innerHTML = `${good} / ${total} bonnes r√©ponses.`;
    document.getElementById("blanksGrid").appendChild(corr);
    setTimeout(()=>renderApprentissage(),2000);
  }
}

// --------- MODE CARTE ---------
window.renderCardMode = function(){
  let arr = [];
  for(let i=1;i<=12;i++) for(let j=1;j<=12;j++) arr.push([i,j]);
  arr.sort(()=>Math.random()-.5);
  window.cardStack = arr;
  window.cardIndex = 0;
  window.cardFlipped = false;
  showCard();
}
window.showCard = function(){
  let [a,b] = window.cardStack[window.cardIndex];
  document.getElementById('apprZone').innerHTML=`
    <div class="card-zone">
      <div class="card3D${window.cardFlipped ? ' flipped':''}" onclick="window.flipCard()">
        <div class="card-flip-side card-flip-front" style="z-index:${window.cardFlipped?1:2};display:${window.cardFlipped?'none':'flex'}">${a} √ó ${b}</div>
        <div class="card-flip-side card-flip-back" style="z-index:${window.cardFlipped?2:1};display:${window.cardFlipped?'flex':'none'}">${a*b}</div>
      </div>
      <div class="card-arrows">
        <button onclick="window.prevCard(event)" ${window.cardIndex===0?'disabled':''}>&lt;</button>
        <button onclick="window.nextCard(event)" ${window.cardIndex===window.cardStack.length-1?'disabled':''}>&gt;</button>
      </div>
      <div style="margin-top:8px;font-size:.99rem;">${window.cardIndex+1} / 144</div>
      <button class="btn" style="margin-top:16px;" onclick="renderApprentissage()">Retour</button>
    </div>
  `;
}
window.flipCard = function () {window.cardFlipped = !window.cardFlipped;window.showCard();}
window.nextCard = function(e){e.stopPropagation();if(window.cardIndex<window.cardStack.length-1){window.cardIndex++;window.cardFlipped=false;window.showCard();}}
window.prevCard = function(e){e.stopPropagation();if(window.cardIndex>0){window.cardIndex--;window.cardFlipped=false;window.showCard();}}

// --------- MODE D√âFI RAPIDE --------
window.renderDefiRapide=function(){
  let arr=[];for(let n=0;n<10;n++){let x=1+Math.floor(Math.random()*12),y=1+Math.floor(Math.random()*12);arr.push([x,y]);}
  window.deFiData = arr; window.deFiIndex=0; window.deFiResults=[];
  nextDeFiQ();
}
function nextDeFiQ(){
  if(window.deFiIndex>=window.deFiData.length)return finishDeFi();
  let [a,b]=window.deFiData[window.deFiIndex];
  document.getElementById('apprZone').innerHTML=`<div style="text-align:center;">
    <div class="progress-bar"><div class="bar-inner" id="defiBar"></div></div>
    <div style="margin:15px 0 7px 0; font-size:1.48rem;font-weight:bold;">${a} √ó ${b}</div>
    <input class="quiz-input" id="defiInput" autocomplete="off" type="number" />
    <div>
      <button class="main-btn" onclick="window.submitDeFi()">Valider</button>
      <button class="btn" onclick="renderApprentissage()">Retour</button>
    </div>
  </div>`;
  animateBar(15,25,()=>window.submitDeFi(true));
  setTimeout(()=>{document.getElementById('defiInput').focus();},100);
}
window.submitDeFi=function(timeout){
  clearTimeout(window.qBarTimer);
  const val = +document.getElementById("defiInput").value;
  let [a,b]=window.deFiData[window.deFiIndex];
  window.deFiResults.push({q:[a,b],a:val,ok:val===a*b,timeout});
  window.deFiIndex++;nextDeFiQ();
}
function finishDeFi(){
  let results=window.deFiResults;
  let ok=results.filter(x=>x.ok&&!x.timeout).length,total=results.length;
  document.getElementById('apprZone').innerHTML = `
    <div style="text-align:center;margin-top:29px;">
      <div style="font-size:1.27rem;margin-bottom:15px;color:var(--accent);font-weight:700;">
        Score du d√©fi : <b>${ok} / ${total}</b>
      </div>
      <div style="font-size:1.06rem;">${results.map(r=>r.ok?'‚úÖ':'‚ùå').join(' ')}</div>
      <button class="main-btn" onclick="renderApprentissage()">Retour</button>
    </div>
  `;
}

// ---------- SUIVI -----------
function renderSuivi(){
  const uid = auth.currentUser.uid, refQ=ref(db,'quizz/'+uid+'/');
  get(refQ).then(snapshot=>{
    let quizz = snapshot.exists()?snapshot.val():[]; quizz = Array.isArray(quizz)?quizz:[];
    let html = `<h1 style="font-size:1.15rem;color:var(--accent);margin:0 0 16px 0;font-weight:800;">Suivi</h1>
    <div style="overflow-x:auto;"><table class="suivi-table">
    <tr><th>Date</th><th>Score</th><th>Temps Out</th><th>Sans faute</th></tr>
    `+quizz.map(q=>{
      let ok=q.results.filter(x=>x.ok&&!x.timeout).length, total=q.results.length;
      return `<tr>
        <td>${new Date(q.date).toLocaleString('fr-FR')}</td>
        <td><b>${ok} / ${total}</b></td>
        <td>${q.results.filter(x=>x.timeout).length}</td>
        <td>${ok===total?"‚úÖ":""}</td>
      </tr>`;
    }).reverse().join("")+`</table></div>`;

    // stats progression
    let mastered=0, tableStats = {};
    quizz.forEach(q=>{
      q.results.forEach(({q:[a,],ok})=>{
        tableStats[a]=tableStats[a]||{ok:0,tot:0};tableStats[a].tot++;if(ok)tableStats[a].ok++;
      });
    });
    for(let i=1;i<=12;i++)if(tableStats[i] && tableStats[i].ok>=5) mastered++;
    let weakest = [], min=1e9;
    for(let i=1;i<=12;i++) if(tableStats[i] && tableStats[i].ok < min){min=tableStats[i].ok;}
    for(let i=1;i<=12;i++) if(tableStats[i] && tableStats[i].ok==min)weakest.push(i);

    html+=`<div class="main-stats">
      <div class="stat-block">
        <div class="stat-title">Tables ma√Ætris√©es</div>
        <div class="num">${mastered}</div>
        <div style="font-size:.93rem;">sur 12</div>
      </div>
      <div class="stat-block">
        <div class="stat-title">Moins bien ma√Ætris√©es</div>
        <div>${weakest.length?weakest.join(', '):"‚Äî"}</div>
      </div>
    </div>
    `;
    content.innerHTML=html;
  });
}

// ---------- PARAMETRES -----------
function renderParametres(){
  const uid = auth.currentUser.uid, settingsRef=ref(db,'settings/'+uid+'/');
  get(settingsRef).then(snap=>{
    let sett = snap.exists()?snap.val():{userName:""};
    content.innerHTML = `
    <h1 style="font-size:1.14rem;color:var(--accent);font-weight:800;">Param√®tres</h1>
    <form id="paramForm" class="param-form">
      <input type="text" id="setUserName" placeholder="Nom d'utilisateur" value="${sett.userName||""}" required>
      <div class="param-btns">
        <button class="save-btn" type="submit">Enregistrer</button>
        <button class="reset-btn" type="button" onclick="window.showResetConfirm()">R√©initialiser progression</button>
      </div>
    </form>
    `;
    document.getElementById("paramForm").onsubmit=(e)=>{
      e.preventDefault();
      update(settingsRef, { userName: document.getElementById("setUserName").value.trim() });
    };
  });
}
window.showResetConfirm = ()=>{
  showConfirm("Voulez-vous vraiment r√©initialiser toute votre progression ? Cette action est irr√©versible.",
    ()=>{
      const uid = auth.currentUser.uid;
      set(ref(db,'quizz/'+uid+'/'),[]); set(ref(db,'settings/'+uid+'/'),{});
      renderSuivi();
    }
  );
};
function showConfirm(msg, yes){
  const confirmLayer=document.getElementById("confirmLayer");
  confirmLayer.innerHTML = `<div class="confirm-box">${msg}<br>
    <button class="main-btn" id="yesBtn">Oui</button>
    <button class="reset-btn" id="noBtn">Non</button>
  </div>`;
  confirmLayer.classList.remove("hidden");
  document.getElementById("yesBtn").onclick=()=>{confirmLayer.classList.add("hidden");yes();};
  document.getElementById("noBtn").onclick=()=>{confirmLayer.classList.add("hidden");};
}
renderPage("tables");
</script>
</body>
</html>
