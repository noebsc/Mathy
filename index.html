<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Mathy by Noé</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Styles très simples et épurés, BEIGE BRIQUE seul, police système -->
  <style>
    :root {
      --beige: #f5ead0;
      --brique: #cb9161;
      --beigeDark: #ddc6a3;
      --accent: #af6a3a;
      --border: #cba582;
      --text: #473423;
      --radius: 12px;
      --shadow: 0 2px 10px #ccb49330;
      --transition: .22s cubic-bezier(.40,.48,.39,.94);
    }
    body {
      background: var(--beige);
      min-height: 100vh;
      margin: 0;
      font-family: system-ui, Arial, sans-serif;
      color: var(--text);
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 3vw; border-bottom: 1px solid var(--border);
      background: var(--beigeDark);
    }
    .left {
      display:flex;align-items:center;gap:20px;
    }
    .burger {
      width:40px;height:40px;display:flex;align-items:center;cursor:pointer;
      background:var(--beige);border-radius:10px;justify-content:center;border:1px solid var(--border);
      transition:box-shadow var(--transition);
    }
    .burger span,.burger span:before,.burger span:after{
      display:block;height:4px;width:24px;border-radius:2px;background:var(--accent);
      position:relative;transition:var(--transition)
    }
    .burger span:before{content:"";position:absolute;top:-7px;}
    .burger span:after{content:"";position:absolute;top:7px;}
    .burger.open span{background:transparent;}
    .burger.open span:before{top:0;transform:rotate(45deg);}
    .burger.open span:after{top:0;transform:rotate(-45deg);}
    .title-mathy{font-weight:bold;font-size:1.8rem;color:var(--accent);}
    .by-noe{font-size:.95rem;color:#a17657;margin-left:8px;font-weight:normal;}
    nav.sidebar {
      position:fixed;top:0;left:-230px;height:100vh;width:200px;z-index:9;
      background:var(--beigeDark);border-right:1px solid var(--border);
      display:flex;flex-direction:column;gap:10px;padding-top:70px;
      transition:left var(--transition);
      box-shadow:0 2px 16px #ad957530;
    }
    nav.sidebar.open { left:0; }
    nav.sidebar button {
      background:none;border:none;font:600 1.12rem system-ui;
      color:var(--accent);padding:12px 28px;text-align:left;cursor:pointer;
      border-radius:var(--radius);
      transition:background var(--transition),color var(--transition);
    }
    nav.sidebar button.active,
    nav.sidebar button:hover {background:var(--accent);color:#fff;}
    nav.sidebar button:last-child {margin-top:auto;color:#903a10;}
    main.content {
      margin:32px 3vw;min-height:60vh;max-width:900px;
      transition:margin var(--transition);
    }
    @media (max-width:600px){main.content{margin:24px 2vw;} nav.sidebar{width:90vw;max-width:290px;left:-93vw;}}
    /* Anim rapides utiles */
    .fade { animation:fade .2s linear; }
    @keyframes fade { from {opacity:0;transform:translateY(18px);} to{opacity:1;transform:translateY(0);} }
    /* TABLES */
    .tables-grid {
      display:grid;grid-template-columns:repeat(auto-fit,minmax(128px,1fr));gap:22px;margin:25px 0 0 0;
    }
    .table-multi {
      border:1.5px solid var(--border);border-radius:10px;padding:11px 8px 8px 8px;
      background:#fff;transition:box-shadow .18s;
      cursor:pointer;text-align:center;
      box-shadow:var(--shadow);
      font-size:1.18rem;
    }
    .table-multi.selected,.table-multi:hover { border:1.8px solid var(--accent);box-shadow:0 3px 10px #cb91615d; background:#fffcf6;}
    /* Zoom Table plein écran */
    .zoom-table-bg {
      position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.16);
      z-index:20;display:flex;align-items:center;justify-content:center;
    }
    .zoom-table {
      background:#fff;border-radius:18px;box-shadow:0 6px 40px #b4854b23;
      padding:32px 38px;margin:0;
      font-size:1.21rem;max-width:95vw;
      border:2.5px solid var(--accent);
    }
    /* QUIZ */
    .quiz-select {
      display:flex;flex-wrap:wrap;gap:10px 24px;margin:18px 0 25px 0;
    }
    .select-table {
      padding:5px 14px;border-radius:8px;border:1.3px solid var(--accent);
      background:#f9ecdb;cursor:pointer;margin-bottom:6px;
      font-size:1rem;transition:background .16s;
      display:flex;align-items:center;gap:7px;
    }
    .select-table.selected, .select-table:active {
      background:var(--accent);color:#fff!important;border:1.5px solid var(--accent);
    }
    .select-table input[type="checkbox"]{margin-right:.6em;}
    /* ProgressBar */
    .progress-bar {
      height:9px;background:#ecd4ae;border-radius:5px;width:270px;max-width:96vw;overflow:hidden;margin:0 auto 14px auto;
      border:1px solid var(--brique);
    }
    .bar-inner {background:var(--accent);height:100%;width:100%;transition:width .11s;}
    /* Input Quiz */
    .quiz-input {font-size:1.5rem;padding:8px 13px;width:110px;}
    /* Mode Blancs Multi */
    .blanks-grid {
      display:grid;grid-template-columns:repeat(4,1fr);gap:12px;
      margin-top:23px;background:#fff;border-radius:12px;padding:22px 7px;
      border:1.5px solid var(--border);
    }
    .blank-box {font-size:1.09rem;}
    .blank-answer {
      width:52px;font-size:1.19rem;text-align:center;margin:0 4px 0 0;
      border:1.2px solid #bdbdbd;border-radius:6px;padding:4px 2px;
    }
    .blank-correct{background:#d4f4da;border:1.5px solid #49b26b;}
    .blank-wrong{background:#fae4db;border:1.5px solid #d46c5d;}
    .correction-row {font-size:0.91rem;color:var(--accent);}
    /* Mode Cartes */
    .card-zone {margin-top:40px;display:flex;flex-direction:column;align-items:center;}
    .card-flip{
      height:130px;width:260px;display:flex;align-items:center;justify-content:center;
      border-radius:16px;background:#fff;font-size:2rem;color:var(--accent);
      border:2.5px solid var(--accent);cursor:pointer;
      perspective:800px;position:relative;transition:box-shadow .19s;
      margin-bottom:18px;box-shadow:0 6px 26px #b4854b19;}
    .flip-animate {
      animation:flipAnim .26s cubic-bezier(.77,0,.23,1.06);
      transform:rotateY(180deg) scale(1.05);
    }
    @keyframes flipAnim {0%{transform:rotateY(0);opacity:.7;}70%{transform:rotateY(180deg) scale(1.13);}90%{transform:rotateY(162deg);} 100%{transform:rotateY(180deg) scale(1.05);}}
    .card-arrows {display:flex;gap:22px;margin-top:12px;}
    .card-arrows button{
      font-size:1.5rem;padding:7px 23px;background:var(--brique);
      color:#fff;border:none;border-radius:8px;cursor:pointer;transition:background .18s;}
    .card-arrows button:disabled {background:#e0c0a6;color:#cb9161;}
    /* Suivi */
    .main-stats{display:flex;flex-wrap:wrap;gap:28px;margin-top:18px;}
    .stat-block {background:#fff;border-radius:10px;box-shadow:var(--shadow);padding:20px 28px;flex:1 1 220px;}
    .stat-block .num{color:var(--accent);font-weight:bold;font-size:1.75rem;}
    .stat-title{font-size:1.04rem;margin-bottom:8px;}
    /* Table historique */
    .suivi-table {width:100%;border-collapse:collapse;}
    .suivi-table th, .suivi-table td {padding:6px 12px;text-align:center;}
    .suivi-table th {background:var(--beigeDark);}
    .suivi-table td {background:#fff;}
    /* Paramètres */
    .param-form {max-width:380px;margin:0 auto;}
    .param-form input[type="text"]{width:100%;padding:9px 12px;font-size:1.08rem;margin-bottom:14px;border:1px solid #bdbdbd;border-radius:8px;}
    .param-btns{display:flex;gap:14px;justify-content:space-between;margin-top:18px;}
    .reset-btn {
      background:#fff;color:#af4a0a;padding:11px 22px;border:1.5px solid #af4a0a;
      border-radius:9px;cursor:pointer;font-weight:bold;transition:background .12s;}
    .reset-btn:hover{background:#af4a0a;color:#fff;}
    .save-btn{background:var(--accent);color:#fff;}
    .confirm-layer{
      position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.22);
      display:flex;align-items:center;justify-content:center;z-index:50;
    }
    .confirm-box{
      background:#fff;padding:30px 40px;border-radius:14px;box-shadow:0 8px 30px #ad957550;
      text-align:center;min-width:230px;
    }
    .confirm-box button{margin:10px 24px 0 24px;}
    .hidden {display:none;}
    /* Mobile */
    @media (max-width:400px){
      .blanks-grid{grid-template-columns:repeat(2,1fr);}
      .card-flip{width:98vw;min-width:148px;}
    }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <div class="burger" id="burger"><span></span></div>
      <span class="title-mathy">Mathy</span>
      <span class="by-noe">by Noé</span>
    </div>
  </header>
  <nav class="sidebar" id="sidebar">
    <button data-page="tables" class="active">Tables</button>
    <button data-page="apprentissage">Apprentissage</button>
    <button data-page="suivi">Suivi</button>
    <button data-page="parametres">Paramètres</button>
    <button id="logoutBtn">Déconnexion</button>
  </nav>
  <main class="content fade" id="content"></main>
  <div id="confirmLayer" class="hidden"></div>
  <div id="authModal" style="position:fixed;z-index:1000;top:0;left:0;right:0;bottom:0; background:#f5ead0;display:flex;align-items:center;justify-content:center;">
    <form id="authForm" style="background:#fff;padding:33px 28px;border-radius:12px;box-shadow:0 5px 35px #bca57e30;display:flex;flex-direction:column;gap:17px;min-width:250px;">
      <h2 style="font-size:1.3rem;color:var(--accent);margin:0 0 14px 0;">Connexion à Mathy</h2>
      <input type="email" id="email" placeholder="Adresse e-mail" required autocomplete="email" style="font-size:1.03rem;padding:10px 5px;border-radius:6px;border:1px solid #cba582;">
      <input type="password" id="password" placeholder="Mot de passe" required autocomplete="current-password" style="font-size:1.03rem;padding:10px 5px;border-radius:6px;border:1px solid #cba582;">
      <button style="background:var(--accent);color:#fff;border:none;border-radius:8px;padding:9px 0;font-size:1.09rem;cursor:pointer;">Se connecter</button>
      <div style="font-size:.98rem;text-align:center;">Pas encore inscrit ? <span id="registerLink" style="color:var(--accent);cursor:pointer;text-decoration:underline;">Créer un compte</span></div>
      <div style="color:#d01f1f;font-size:.97rem;" id="authError"></div>
    </form>
  </div>
<script type="module">
// ============== Firebase (v12) ==============
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getDatabase, ref, set, get, update } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
const firebaseConfig = {
  apiKey: "AIzaSyAz4RmoInpNHsjCMHM6tMdv1SWgUEB7ZyI",
  authDomain: "mathy-f7fc0.firebaseapp.com",
  databaseURL: "https://mathy-f7fc0-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "mathy-f7fc0",
  storageBucket: "mathy-f7fc0.appspot.com",
  messagingSenderId: "612107190361",
  appId: "1:612107190361:web:4b8c56d142372fc100f148",
  measurementId: "G-RQYNBK3BDE"
};
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth(app);
const db = getDatabase(app);

// ============= Interface Navigation =============
const burger = document.getElementById("burger"), sidebar = document.getElementById("sidebar"), content = document.getElementById("content");
burger.onclick = () => { burger.classList.toggle('open'); sidebar.classList.toggle('open'); };
document.body.addEventListener("mousedown", e=>{
  if (sidebar.classList.contains('open') && !sidebar.contains(e.target) && !burger.contains(e.target)) {
    burger.classList.remove('open'); sidebar.classList.remove('open');
  }
});
sidebar.querySelectorAll("button[data-page]").forEach(btn => {
  btn.onclick = () => switchPage(btn.dataset.page, btn);
});
let currentPage = "tables";
function switchPage(page, btn){
  sidebar.querySelectorAll("button[data-page]").forEach(b=>b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  currentPage = page;
  content.classList.remove("fade");
  setTimeout(()=>{ renderPage(page); content.classList.add("fade"); }, 60);
  if(window.innerWidth<700){ burger.classList.remove('open'); sidebar.classList.remove('open'); }
}

// ============= Authentification =============
const authModal = document.getElementById("authModal");
const authForm = document.getElementById("authForm");
const emailInput = document.getElementById("email");
const pwInput = document.getElementById("password");
const authError = document.getElementById("authError");
const registerLink = document.getElementById("registerLink");
let isRegisterMode = false;
registerLink.onclick = ()=>{
  isRegisterMode = !isRegisterMode;
  authForm.querySelector("button[type='submit']").innerText = isRegisterMode ? "Créer un compte" : "Se connecter";
  registerLink.innerText = isRegisterMode ? "Déjà inscrit ? Se connecter" : "Créer un compte";
};
authForm.onsubmit = async (e)=>{
  e.preventDefault();
  authError.innerText = "";
  try{
    if(isRegisterMode){
      await createUserWithEmailAndPassword(auth, emailInput.value, pwInput.value);
      await set(ref(db,'settings/'+auth.currentUser.uid), { userName:emailInput.value.split("@")[0] });
    } else {
      await signInWithEmailAndPassword(auth, emailInput.value, pwInput.value);
    }
  } catch(err){ authError.innerText = err.message; }
}
onAuthStateChanged(auth, user=>{
  if (user) { authModal.style.display = "none"; renderPage(currentPage);}
  else {authModal.style.display = "flex"; content.innerHTML = "";}
});
document.getElementById("logoutBtn").onclick = ()=>{ signOut(auth); }

// ============= Pages =============
function renderPage(page){
  if (page==="tables") renderTables();
  else if (page==="apprentissage") renderApprentissage();
  else if (page==="suivi") renderSuivi();
  else if (page==="parametres") renderParametres();
}

// ----------- TABLES MULTIPLICATION -----------
function renderTables(){
  let html = `<h1 style="font-size:1.4rem;color:var(--accent);margin:0 0 7px 0;">Toutes les tables de multiplication</h1>
    <div class="tables-grid">`;
  for(let t=1;t<=12;t++){
    html+=`<div class="table-multi" onclick="showTableZoom(${t})" id="t${t}">
      <div style="font-weight:bold;color:var(--accent);font-size:1.12rem;">Table de ${t}</div>
      <div>`;
    for(let i=1;i<=12;i++){ html += `<div>${t} × ${i} = <b>${t*i}</b></div>`;}
    html+=`</div></div>`;
  }
  html+=`</div>`;
  content.innerHTML = html;
}
window.showTableZoom = function(n){
  const overlay=document.createElement('div');
  overlay.className='zoom-table-bg';
  overlay.onclick=e=>{if(e.target===overlay)overlay.remove();}
  let html = `<div class="zoom-table"><h2 style="color:var(--accent);font-size:1.31rem;margin:0 0 8px 0;">Table de ${n}</h2>`;
  for(let i=1;i<=12;i++) html+=`<div>${n} × ${i} = <b>${n*i}</b></div>`;
  html+=`</div>`;
  overlay.innerHTML=html;document.body.appendChild(overlay);
}

// ----------- APPRENTISSAGE (MODES) -----------
function renderApprentissage(){
  content.innerHTML=`
    <h1 style="font-size:1.25rem;color:var(--accent);">Apprentissage</h1>
    <div style="margin:15px 0 22px 0;display:flex;gap:20px;flex-wrap:wrap;">
      <button class="save-btn" style="padding:12px 25px;" onclick="selectQuizTables()">Quiz</button>
      <button class="save-btn" style="padding:12px 25px;" onclick="renderBlanksQuiz()">Tables à trous</button>
      <button class="save-btn" style="padding:12px 25px;" onclick="renderCardMode()">Mode cartes</button>
    </div>
    <div id="apprZone"></div>
  `;
}
window.selectQuizTables = function(){
  let tables = '';
  for(let i=1;i<=12;i++)
    tables += `<label class="select-table" id="qsel${i}" onclick="event.preventDefault();toggleQuizTable(${i})">
      <input type="checkbox" id="ch${i}" value="${i}" checked style="pointer-events:none;"> ${i}
    </label>`;
  document.getElementById('apprZone').innerHTML = `
    <div><b>Choisis les tables à travailler :</b></div>
    <div class="quiz-select">${tables}</div>
    <button onclick="startQuiz()" class="save-btn" style="margin:18px 0;">Démarrer le quiz</button>
  `;
  window.selectedQuizTables = Array(12).fill(true);
}
window.toggleQuizTable = function(n){
  window.selectedQuizTables[n-1] = !window.selectedQuizTables[n-1];
  document.getElementById('ch'+n).checked = window.selectedQuizTables[n-1];
  let elem=document.getElementById('qsel'+n);
  if(window.selectedQuizTables[n-1]) elem.classList.add('selected');
  else elem.classList.remove('selected');
}
window.startQuiz = function(){
  let arr=[];for(let i=1;i<=12;i++)if(window.selectedQuizTables[i-1])for(let j=1;j<=12;j++)arr.push([i,j]);
  if(arr.length===0){alert("Sélectionne au moins une table.");return;}
  arr.sort(()=>Math.random()-.5);
  window.quizData = arr; window.quizIndex=0; window.quizResults=[]; nextQuiz();
}
function nextQuiz(){
  if(window.quizIndex>=window.quizData.length) return finishQuiz();
  let [a,b]=window.quizData[window.quizIndex];
  let apprZone = document.getElementById('apprZone');
  apprZone.innerHTML=`<div style="text-align:center;">
    <div class="progress-bar"><div class="bar-inner" id="qtimer"></div></div>
    <div style="margin:10px 0; font-size:1.58rem;font-weight:bold;">${a} × ${b}</div>
    <input class="quiz-input" id="quizAnswer" autocomplete="off" type="number" />
    <div><button class="save-btn" onclick="submitQuizAnswer()">Valider</button></div>
  </div>`;
  animateBar(10,500,()=>submitQuizAnswer(true));
  setTimeout(()=>{document.getElementById('quizAnswer').focus();},200);
}
function animateBar(sec,interval,callback){
  const bar=document.getElementById('qtimer');
  let progress=100,step=100/(sec*1000/interval);
  let timer = setInterval(()=>{
    progress-=step; bar.style.width=Math.max(progress,0)+'%';
    if(progress<=0){clearInterval(timer);callback();}
  },interval);window.qBarTimer=timer;
}
window.submitQuizAnswer = function(timeout){
  clearInterval(window.qBarTimer);
  const val = +document.getElementById("quizAnswer").value;
  let [a,b] = window.quizData[window.quizIndex];
  window.quizResults.push({q: [a,b], a: val, ok: val===a*b, timeout});
  window.quizIndex++; nextQuiz();
}
function finishQuiz(){
  // Save and display results
  let results = window.quizResults;
  let ok=results.filter(x=>x.ok&&!x.timeout).length,total=results.length;
  let timeouts=results.filter(x=>x.timeout).length;
  saveQuizToDB(results);
  document.getElementById('apprZone').innerHTML = `
    <div style="text-align:center;margin-top:29px;">
      <div style="font-size:1.23rem;margin-bottom:14px;color:var(--accent);">
        Résultat : <b>${ok} / ${total}</b>
      </div>
      <div style="font-size:.99rem;">Questions hors temps : <b>${timeouts}</b></div>
      <button class="save-btn" onclick="renderApprentissage()" style="margin-top:20px;">Retour</button>
    </div>
  `;
}
function saveQuizToDB(results){
  const uid = auth.currentUser.uid;
  const quiz = { results, date: Date.now() };
  const refQ = ref(db, 'quizz/'+uid+'/');
  get(refQ).then(snapshot=>{
    let arr = snapshot.exists() ? snapshot.val() : [];
    arr=Array.isArray(arr)?arr:[]; arr.push(quiz); set(refQ, arr);
  });
}

// ----------- QUIZ À TROUS -----------
function renderBlanksQuiz(){
  let qs=[], answers=[], pos=0;
  for(let t=1;t<=12;t++)for(let i=1;i<=12;i++)qs.push({t,i, blank:Math.random()<.38 });
  document.getElementById('apprZone').innerHTML = `
    <form id="blankQuizForm">
    <div><b>Complète les cases manquantes :</b></div>
    <div class="blanks-grid" id="blanksGrid">
    ${qs.map((q,j)=>q.blank?
      `<span class="blank-box">${q.t} × ${q.i} = 
        <input type="number" class="blank-answer" id="bq${j}" data-resp="${q.t*q.i}" required autocomplete="off">
      </span>`
      : `<span class="blank-box">${q.t} × ${q.i} = <b>${q.t*q.i}</b></span>`
    ).join("")}
    </div>
    <button class="save-btn" type="submit" style="margin:14px auto;display:block;">Vérifier</button>
    </form>
  `;
  document.getElementById("blankQuizForm").onsubmit=(e)=>{
    e.preventDefault();
    let good=0, bad=0, total=0;
    let inputs = Array.from(document.querySelectorAll(".blank-answer"));
    for(let inp of inputs){
      total++;
      if(+inp.value==+inp.dataset.resp){inp.classList.add("blank-correct");good++;}
      else {inp.classList.add("blank-wrong");bad++;}
      inp.disabled=true;
    }
    let corr = document.createElement("div");
    corr.className="correction-row";
    corr.innerHTML = `${good} / ${total} bonnes réponses.`;
    document.getElementById("blanksGrid").appendChild(corr);
    setTimeout(()=>renderApprentissage(),2200);
  }
}

// ----------- MODE CARTES -----------
function renderCardMode(){
  let arr = [];
  for(let i=1;i<=12;i++) for(let j=1;j<=12;j++) arr.push([i,j]);
  arr.sort(()=>Math.random()-.5);
  window.cardStack=arr;window.cardIndex=0;window.cardFlipped=false;
  showCard();
}
function showCard(){
  let [a,b] = window.cardStack[window.cardIndex];
  let flip = window.cardFlipped ? 'flip-animate':'';
  document.getElementById('apprZone').innerHTML=`
    <div class="card-zone">
      <div class="card-flip ${flip}" onclick="flipCard()">
        ${window.cardFlipped ? `<span>${a*b}</span>` : `<span>${a} × ${b}</span>`}
      </div>
      <div class="card-arrows">
        <button onclick="prevCard(event)" ${window.cardIndex===0?'disabled':''}>&lt;</button>
        <button onclick="nextCard(event)" ${window.cardIndex===window.cardStack.length-1?'disabled':''}>&gt;</button>
      </div>
      <div style="margin-top:7px;font-size:.97rem;">${window.cardIndex+1} / 144</div>
    </div>
  `;
}
window.flipCard = ()=>{window.cardFlipped=!window.cardFlipped;showCard();};
window.nextCard = e=>{e.stopPropagation();if(window.cardIndex<window.cardStack.length-1){window.cardIndex++;window.cardFlipped=false;showCard();}};
window.prevCard = e=>{e.stopPropagation();if(window.cardIndex>0){window.cardIndex--;window.cardFlipped=false;showCard();}};

// ----------- SUIVI -----------
function renderSuivi(){
  const uid = auth.currentUser.uid, refQ=ref(db,'quizz/'+uid+'/');
  get(refQ).then(snapshot=>{
    let quizz = snapshot.exists()?snapshot.val():[]; quizz = Array.isArray(quizz)?quizz:[];
    let html = `<h1 style="font-size:1.19rem;color:var(--accent);margin:0 0 15px 0;">Suivi</h1>
    <div style="overflow-x:auto;"><table class="suivi-table">
    <tr><th>Date</th><th>Score</th><th>Temps Out</th><th>Sans faute</th></tr>
    `+quizz.map(q=>{
      let ok=q.results.filter(x=>x.ok&&!x.timeout).length, total=q.results.length;
      return `<tr>
        <td>${new Date(q.date).toLocaleString('fr-FR')}</td>
        <td><b>${ok} / ${total}</b></td>
        <td>${q.results.filter(x=>x.timeout).length}</td>
        <td>${ok===total?"✅":""}</td>
      </tr>`;
    }).reverse().join("")+`</table></div>`;

    // stats progression
    let mastered=0, tableStats = {};
    quizz.forEach(q=>{
      q.results.forEach(({q:[a,],ok})=>{
        tableStats[a]=tableStats[a]||{ok:0,tot:0};tableStats[a].tot++;if(ok)tableStats[a].ok++;
      });
    });
    for(let i=1;i<=12;i++)if(tableStats[i] && tableStats[i].ok>=5) mastered++;
    let weakest = [], min=1e9;
    for(let i=1;i<=12;i++) if(tableStats[i] && tableStats[i].ok < min){min=tableStats[i].ok;}
    for(let i=1;i<=12;i++) if(tableStats[i] && tableStats[i].ok==min)weakest.push(i);

    html+=`<div class="main-stats">
      <div class="stat-block">
        <div class="stat-title">Tables maîtrisées</div>
        <div class="num">${mastered}</div>
        <div style="font-size:.93rem;">sur 12</div>
      </div>
      <div class="stat-block">
        <div class="stat-title">Moins bien maîtrisées</div>
        <div>${weakest.length?weakest.join(', '):"—"}</div>
      </div>
    </div>
    `;
    content.innerHTML=html;
  });
}

// ----------- PARAMETRES -----------
function renderParametres(){
  const uid = auth.currentUser.uid, settingsRef=ref(db,'settings/'+uid+'/');
  get(settingsRef).then(snap=>{
    let sett = snap.exists()?snap.val():{userName:""};
    content.innerHTML = `
    <h1 style="font-size:1.2rem;color:var(--accent);">Paramètres</h1>
    <form id="paramForm" class="param-form">
      <input type="text" id="setUserName" placeholder="Nom d'utilisateur" value="${sett.userName||""}" required>
      <div class="param-btns">
        <button class="save-btn" type="submit">Enregistrer</button>
        <button class="reset-btn" type="button" onclick="showResetConfirm()">Réinitialiser progression</button>
      </div>
    </form>
    `;
    document.getElementById("paramForm").onsubmit=(e)=>{
      e.preventDefault();
      update(settingsRef, { userName: document.getElementById("setUserName").value.trim() });
    };
  });
}
window.showResetConfirm = ()=>{
  showConfirm("Voulez-vous vraiment réinitialiser toute votre progression ? Cette action est irréversible.",
    ()=>{
      const uid = auth.currentUser.uid;
      set(ref(db,'quizz/'+uid+'/'),[]); set(ref(db,'settings/'+uid+'/'),{});
      renderSuivi();
    }
  );
};
function showConfirm(msg, yes){
  const confirmLayer=document.getElementById("confirmLayer");
  confirmLayer.innerHTML = `<div class="confirm-box">${msg}<br>
    <button class="save-btn" id="yesBtn">Oui</button>
    <button class="reset-btn" id="noBtn">Non</button>
  </div>`;
  confirmLayer.classList.remove("hidden");
  document.getElementById("yesBtn").onclick=()=>{confirmLayer.classList.add("hidden");yes();};
  document.getElementById("noBtn").onclick=()=>{confirmLayer.classList.add("hidden");};
}
renderPage("tables");
</script>
</body>
</html>
