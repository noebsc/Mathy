<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Mathy by Noé</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@800&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --beige: #e9dec2;
      --brique: #cf9773;
      --glass-dark: rgba(207, 151, 115, 0.17);
      --glass-light: rgba(233, 222, 194, 0.6);
      --glass: rgba(230, 202, 171, 0.4);
      --accent: #db6a3c;
      --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.10);
      --radius: 24px;
      --transition: all 0.7s cubic-bezier(.77,0,.18,1);
      --font-main: 'Montserrat', sans-serif;
      --font-title: 'Orbitron', sans-serif;
    }
    body {
      background: linear-gradient(135deg, var(--beige) 70%, var(--brique));
      min-height: 100vh;
      margin: 0;
      font-family: var(--font-main);
      overflow-x: hidden;
    }
    .glass {
      background: var(--glass-dark);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1.5px solid var(--glass-light);
      transition: var(--transition);
    }
    header {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 16px 32px;
    }
    .burger {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: var(--glass);
      border-radius: 50%;
      margin-right: 16px;
      z-index: 20;
      transition: var(--transition);
      border: 1px solid var(--beige);
      box-shadow: var(--shadow);
    }
    .burger span, .burger span:before, .burger span:after {
      content: '';
      display: block;
      background: var(--accent);
      height: 4px;
      width: 30px;
      border-radius: 2px;
      transition: var(--transition);
      position: relative;
    }
    .burger span { position: relative; }
    .burger span:before {
      position: absolute;
      top: -10px;
    }
    .burger span:after {
      position: absolute;
      top: 10px;
    }
    /* Burger active animation */
    .burger.open span { background: transparent; }
    .burger.open span:before {
      top: 0;
      transform: rotate(45deg);
    }
    .burger.open span:after {
      top: 0;
      transform: rotate(-45deg);
    }
    .title-mathy {
      font-family: var(--font-title);
      font-size: 2.7rem;
      color: var(--accent);
      letter-spacing: 1px;
      user-select: none;
      font-weight: 800;
      margin-right: 12px;
      text-shadow: 2px 3px 14px #cf977341;
      /* glass underline effect */
      background: linear-gradient(180deg, var(--accent) 50%, var(--beige) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .by-noe {
      font-family: var(--font-main);
      font-size: 1.15rem;
      color: #9d6d4e;
      font-weight: 600;
      opacity: 0.7;
      margin-top: 18px;
      margin-left: 4px;
    }
    /* Sidebar menu */
    .sidebar {
      position: fixed;
      top: 0;
      left: -240px;
      height: 100vh;
      width: 240px;
      background: var(--glass);
      box-shadow: 6px 0 32px 0 rgba(31, 38, 135, 0.15);
      z-index: 10;
      transition: left 0.6s cubic-bezier(.77,0,.18,1);
      padding-top: 90px;
      display: flex;
      flex-direction: column;
      gap: 25px;
      backdrop-filter: blur(30px);
    }
    .sidebar.open {
      left: 0;
    }
    .sidebar button {
      background: transparent;
      border: none;
      font: 700 1.25rem var(--font-main);
      color: var(--brique);
      text-align: left;
      padding: 14px 30px;
      cursor: pointer;
      border-radius: 14px;
      transition: var(--transition);
    }
    .sidebar button.active, .sidebar button:hover {
      background: var(--accent);
      color: #fff;
      font-weight: bold;
      letter-spacing: .5px;
      box-shadow: 0 2px 6px #b5795933;
      transform: translateX(10px) scale(1.07);
    }
    .content {
      margin: 24px 30px 40px 270px;
      transition: var(--transition);
    }
    @media (max-width: 700px) {
      .content { margin-left: 0; }
      .sidebar { width: 93vw; }
    }
    /* Animations */
    .fade-in {
      animation: fadeIn 1.2s cubic-bezier(.44,.69,.19,.97);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(24px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .popup {
      animation: popup .7s cubic-bezier(.88,-0.21,.03,1.2);
    }
    @keyframes popup {
      0% {transform: scale(.7);}
      60% {transform: scale(1.06);}
      100% {transform: scale(1);}
    }
    .glass-btn {
      background: var(--brique);
      color: var(--beige);
      border: none;
      padding: 14px 40px;
      font-size: 1.1rem;
      border-radius: 12px;
      box-shadow: var(--shadow);
      margin: 22px 0;
      cursor: pointer;
      font-weight: bold;
      letter-spacing: .7px;
      transition: var(--transition);
    }
    .glass-btn:active {
      background: var(--accent);
      transform: scale(.95);
    }
    .fullscreen-table {
      position: fixed;
      z-index: 9;
      left: 0; right: 0; top: 0; bottom: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(210, 167, 135, 0.35);
      animation: fadeIn .7s;
      cursor: pointer;
    }
    /* Progress bar for quiz */
    .progress-bar {
      width: 100%;
      height: 10px;
      border-radius: 8px;
      background: #ecd4ae;
      overflow: hidden;
      margin-bottom: 24px;
    }
    .progress {
      height: 100%;
      background: var(--accent);
      border-radius: 8px;
      width: 100%;
      transition: width 0.8s cubic-bezier(.65,0,.55,1);
    }
    /* Card styles */
    .card-mode {
      min-width: 320px;
      max-width: 420px;
      height: 200px;
      margin: 0 auto;
      margin-top: 55px;
      perspective: 1500px;
      position: relative;
    }
    .flip-card {
      width: 100%;
      height: 100%;
      transition: var(--transition);
      transform-style: preserve-3d;
      position: relative;
    }
    .card-front, .card-back {
      width: 100%;
      height: 100%;
      border-radius: 16px;
      background: var(--glass);
      box-shadow: var(--shadow);
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 2.1rem;
      font-weight: bold;
      color:var(--accent);
      backface-visibility: hidden;
    }
    .card-back {
      transform: rotateY(180deg);
      color: #fff;
      background: var(--accent);
    }
    .flip-card.flipped {
      transform: rotateY(180deg);
    }
    .card-arrows {
      display: flex;
      position: absolute;
      top: 50%;
      left: -45px;
      right: -45px;
      justify-content: space-between;
      align-items: center;
      width: calc(100% + 90px);
      pointer-events: none;
    }
    .card-arrows button {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      font-size: 1.6rem;
      pointer-events: auto;
      cursor: pointer;
      box-shadow: 0 4px 12px #b5795948;
      transition: var(--transition);
    }
    /* Glass morph forms */
    .glass-form input {
      width: 260px;
      padding: 13px;
      margin: 14px 0;
      border: none;
      border-radius: 9px;
      box-shadow: var(--shadow);
      background: var(--glass-light);
      color: var(--brique);
      font-size:1.08rem;
      outline: none;
      transition: box-shadow .6s, background .7s;
    }
    .glass-form input:focus {
      background:var(--glass);
      box-shadow: 0 6px 30px #cf977374;
    }
    .confirm-box {
      position: fixed; z-index: 100; top:0;left:0;right:0;bottom:0; display: flex;align-items:center;justify-content: center;
      background:rgba(0,0,0,.42); animation:fadeIn .2s;
    }
    .confirm-message {
      background: var(--glass-light);
      border-radius: 16px;
      padding: 42px 46px;
      box-shadow: var(--shadow);
      font-size: 1.2rem;
      color: var(--brique);
      text-align: center;
      animation:popup .5s;
    }
    .confirm-buttons {
      display: flex; justify-content:center; gap:22px; margin-top:20px;
    }
    /* Scrollbar */
    ::-webkit-scrollbar { width: 9px; background:var(--beige);}
    ::-webkit-scrollbar-thumb { background:var(--glass-dark); border-radius:3px;}
    /* Responsive */
    @media (max-width: 600px) { .card-mode { max-width:98vw; min-width:0; } .sidebar { left: -93vw; width:93vw;} .content {margin: 24px 6vw 40px 8vw;} }
  </style>
</head>
<body>
  <header>
    <div class="burger" id="burger"><span></span></div>
    <div class="title-mathy">Mathy<span class="by-noe">by Noé</span></div>
  </header>
  <nav class="sidebar glass" id="sidebar">
    <button data-page="tables" class="active">Tables de multiplication</button>
    <button data-page="apprentissage">Apprentissage</button>
    <button data-page="suivi">Suivi</button>
    <button data-page="parametres">Paramètres</button>
    <button id="logoutBtn" style="margin-top:auto;color:#b04f15;">Déconnexion</button>
  </nav>
  <main class="content fade-in" id="content"></main>

  <!-- Confirmation Popup -->
  <div id="confirmBox" style="display:none;">
    <div class="confirm-box">
      <div class="confirm-message">
        <span id="confirmMsg"></span>
        <div class="confirm-buttons">
          <button class="glass-btn" id="confirmYes">Oui</button>
          <button class="glass-btn" id="confirmNo">Non</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- AUTH Modal -->
  <div id="authModal" style="position:fixed;z-index:1000;top:0;left:0;right:0;bottom:0; background:rgba(240,211,192,.93);display:flex;align-items:center;justify-content:center;">
    <form id="authForm" class="glass glass-form" style="min-width:340px;display:flex;flex-direction:column;align-items:center;padding:42px 38px;">
      <h2 style="font-family:var(--font-title);font-size:2rem;color:var(--accent);">Connexion à Mathy</h2>
      <input type="email" id="email" placeholder="Adresse e-mail" required autocomplete="email" />
      <input type="password" id="password" placeholder="Mot de passe" required autocomplete="current-password" />
      <button class="glass-btn" type="submit" style="margin-bottom:19px;">Se connecter</button>
      <div style="text-align:center;font-size:1.05rem;margin-bottom:.6em;">
        Pas encore inscrit ? <span id="registerLink" style="color:var(--accent);cursor:pointer;text-decoration:underline;">Créer un compte</span>
      </div>
      <div style="color:#bf3838;font-size:1rem;" id="authError"></div>
    </form>
  </div>

  <!-- Firebase SDKs (auth + firestore if ok) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getDatabase, ref, set, get, update, onValue } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAz4RmoInpNHsjCMHM6tMdv1SWgUEB7ZyI",
      authDomain: "mathy-f7fc0.firebaseapp.com",
      databaseURL: "https://mathy-f7fc0-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "mathy-f7fc0",
      storageBucket: "mathy-f7fc0.firebasestorage.app",
      messagingSenderId: "612107190361",
      appId: "1:612107190361:web:4b8c56d142372fc100f148",
      measurementId: "G-RQYNBK3BDE"
    };
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // --- BURGER/SIDEBAR ---
    const burger = document.getElementById("burger");
    const sidebar = document.getElementById("sidebar");
    burger.onclick = () => {
      burger.classList.toggle('open');
      sidebar.classList.toggle('open');
    };
    // Rétracter sidebar si clic à l'extérieur
    document.body.addEventListener("mousedown", e=>{
      if (sidebar.classList.contains('open') && !sidebar.contains(e.target) && !burger.contains(e.target)) {
        burger.classList.remove('open'); sidebar.classList.remove('open');
      }
    });

    // --- NAVIGATION ---
    const content = document.getElementById("content");
    sidebar.querySelectorAll("button[data-page]").forEach(btn => {
      btn.onclick = () => switchPage(btn.dataset.page, btn);
    });
    let currentPage = "tables";
    function switchPage(page, btn){
      sidebar.querySelectorAll("button[data-page]").forEach(b=>b.classList.remove('active'));
      if (btn) btn.classList.add('active');
      currentPage = page;
      document.querySelector('.content').classList.remove("fade-in");
      setTimeout(()=>{ renderPage(page); document.querySelector('.content').classList.add("fade-in"); }, 260);
      if(window.innerWidth<700){ burger.classList.remove('open'); sidebar.classList.remove('open'); }
    }

    // --- AUTHENTIFICATION ---
    const authModal = document.getElementById("authModal");
    const authForm = document.getElementById("authForm");
    const emailInput = document.getElementById("email");
    const pwInput = document.getElementById("password");
    const authError = document.getElementById("authError");
    const registerLink = document.getElementById("registerLink");

    let isRegisterMode = false;
    registerLink.onclick = ()=>{
      isRegisterMode = !isRegisterMode;
      authForm.querySelector("button[type='submit']").innerText = isRegisterMode ? "Créer un compte" : "Se connecter";
      registerLink.innerText = isRegisterMode ? "Déjà inscrit ? Se connecter" : "Créer un compte";
    };
    authForm.onsubmit = async (e)=>{
      e.preventDefault();
      authError.innerText = "";
      if(isRegisterMode){
        try{
          await createUserWithEmailAndPassword(auth, emailInput.value, pwInput.value);
        } catch(err){ authError.innerText = err.message; }
      } else {
        try{
          await signInWithEmailAndPassword(auth, emailInput.value, pwInput.value);
        } catch(err){ authError.innerText = err.message; }
      }
    }
    // Gestion state utilisateur
    onAuthStateChanged(auth, user=>{
      if (user) {
        authModal.style.display = "none";
        renderPage(currentPage);
      } else {
        authModal.style.display = "flex";
        content.innerHTML = "";
      }
    });
    // Déconnexion
    document.getElementById("logoutBtn").onclick = ()=>{
      signOut(auth);
    }

    // ---- CORE PAGES ----
    // -------------------- T A B L E S (de base) --------------------
    function renderPage(page){
      if (page==="tables"){ renderTablesMultiplication(); }
      else if (page==="apprentissage"){ renderApprentissage(); }
      else if (page==="suivi"){ renderSuivi(); }
      else if (page==="parametres"){ renderParametres(); }
    }

    // TABLES PAGE
    function renderTablesMultiplication(){
      let html = `<h1 style="color:var(--accent);font-size:2.09rem;">Tables de multiplication</h1>
      <div id="tables-list" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:34px; margin-top:34px;">`;
      // 1 à 12
      for(let i=1;i<=12;i++){
        html += `<div class="glass fade-in" style="padding:32px 0 24px 0; text-align:center; cursor:pointer; font-size:1.6rem; transition:transform .8s cubic-bezier(.77,.2,.12,1);"
        onclick="showTableFull(${i})" id="tableCard${i}">
        <div style="font-size:2.1rem;font-family:var(--font-title);color:var(--brique);">Table de ${i}</div></div>`;
      }
      html += '</div>';
      content.innerHTML = html;
    }
    window.showTableFull = showTableFull; // Pour onclick

    let tableFullMode = false;
    function showTableFull(n){
      if(tableFullMode) return;
      tableFullMode = true;
      const overlay = document.createElement('div');
      overlay.className = "fullscreen-table";
      overlay.onclick = (e)=> {
        if(e.target===overlay){ overlay.classList.add('fade-out'); setTimeout(()=>{overlay.remove(); tableFullMode=false;},370);}
      };
      let html = `<div class="glass popup" style="min-width:360px;max-width:95vw;padding:60px 70px;text-align:center;">
      <h2 style="font-family:var(--font-title);font-size:2rem;color:var(--accent);">Table de ${n}</h2>
      <div style="font-size:1.65rem;color:var(--brique);padding:21px 0">`;
      for(let i=1;i<=12;i++){ html += `${n} × ${i} = <b>${n*i}</b><br>`; }
      html += '</div></div>';
      overlay.innerHTML = html;
      document.body.appendChild(overlay);
    }

    // -------------------- A P P R E N T I S S A G E --------------------
    function renderApprentissage(){
      content.innerHTML = `
        <h1 style="color:var(--accent);font-size:2rem;">Apprentissage</h1>
        <div style="display:flex;gap:38px;flex-wrap:wrap;margin-top:20px;">
          <div class="glass fade-in" style="padding:34px;min-width:290px;flex:1;">
            <div style="font-size:1.18rem;font-weight:bold;color:var(--accent);margin-bottom:16px;">Démarrer un quiz</div>
            <div style="font-size:1rem; color:var(--brique);">Sélectionne les tables, puis lance le quiz !</div>
            <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin:17px 0 13px 0;" id="quiz-tables">` +
            Array.from({length:12},(_,i)=>`<label style="color:var(--brique);font-size:1.02rem;">
              <input type="checkbox" class="quiz-table" value="${i+1}" checked /> ${i+1}
            </label>`).join("")
            +`</div>
            <button class="glass-btn" onclick="startQuiz()">Commencer le quiz</button>
          </div>
          <div class="glass fade-in" style="padding:34px;min-width:290px;flex:1;">
            <div style="font-size:1.17rem;font-weight:bold;color:var(--accent);margin-bottom:18px;">Questionnaire avec blancs</div>
            <div style="font-size:1rem; color:var(--brique);margin-bottom:18px;">Complète tous les trous !</div>
            <button class="glass-btn" onclick="startWhiteQuiz()">Faire le questionnaire</button>
          </div>
          <div class="glass fade-in" style="padding:34px;min-width:290px;flex:1;">
            <div style="font-size:1.18rem;font-weight:bold;color:var(--accent);margin-bottom:18px;">Mode Cartes</div>
            <div style="font-size:1rem;color:var(--brique);margin-bottom:18px;">Fais défiler et découvre les réponses !</div>
            <button class="glass-btn" onclick="startCardMode()">Lancer le mode cartes</button>
          </div>
        </div>
      `;
    }
    window.startQuiz = startQuiz;
    window.startWhiteQuiz = startWhiteQuiz;
    window.startCardMode = startCardMode;

    // ----------- Quiz mode ----------
    let quizData = [], quizIndex = 0, timer = null, quizResults = [];
    function startQuiz(){
      let selected = Array.from(document.querySelectorAll(".quiz-table:checked")).map(e=>+e.value);
      quizData = [];
      selected.forEach(t => { for(let i=1;i<=12;i++) quizData.push([t,i]); });
      quizData = quizData.sort(()=>Math.random()-.5); // shuffle
      quizIndex = 0; quizResults = [];
      showQuizQuestion();
    }
    function showQuizQuestion(){
      if(quizIndex>=quizData.length) return finishQuiz();
      let [a,b]=quizData[quizIndex];
      content.innerHTML = `
        <div style="text-align:center;padding-top:44px;">
          <div class="progress-bar"><div class="progress" id="quizProgress"></div></div>
          <div class="glass popup" style="font-size:2.2rem; font-family:var(--font-title); color:var(--accent); margin-bottom:30px; padding:30px;">${a} × ${b}</div>
          <input type="number" style="font-size:2rem;padding:15px;width:150px;margin:8px;" id="quizAnswer" autocomplete="off" />
          <div><button class="glass-btn" onclick="submitQuizAnswer()">Valider</button></div>
        </div>`;
      animateQuizBar();
      setTimeout(()=>{document.getElementById("quizAnswer").focus();},200);
    }
    function animateQuizBar(){
      const bar = document.getElementById("quizProgress");
      let time = 10;
      bar.style.width = "100%";
      if(timer) clearInterval(timer);
      timer = setInterval(()=>{
        time-=0.1;
        bar.style.width = ((time/10)*100)+"%";
        if(time<=0){ clearInterval(timer); submitQuizAnswer(true);}
      },70);
    }
    window.submitQuizAnswer = submitQuizAnswer;
    function submitQuizAnswer(timeout=false){
      clearInterval(timer);
      const val = +document.getElementById("quizAnswer").value;
      quizResults.push({q:quizData[quizIndex], a:val, ok: val===(quizData[quizIndex][0]*quizData[quizIndex][1]), timeout});
      quizIndex++;
      showQuizQuestion();
    }
    function finishQuiz(){
      // Sauvegarde et affichage score rapide
      let ok=quizResults.filter(x=>x.ok&&!x.timeout).length, total=quizResults.length;
      saveQuizToDB(quizResults);
      content.innerHTML = `
        <div class="glass popup" style="text-align:center;font-size:1.4rem;padding:34px;max-width:520px;margin:52px auto;">
          <div style="color:var(--accent);font-size:2rem;font-family:var(--font-title);margin-bottom:18px;">Quiz terminé !</div>
          <div>Score : <b>${ok} / ${total}</b></div>
          <div style="margin:15px 0 8px 0;color:var(--brique);">Temps dépassé : ${quizResults.filter(x=>x.timeout).length}</div>
          <button class="glass-btn" onclick="switchPage('apprentissage')">Retour</button>
        </div>
      `;
    }
    // --- Sauvegarde quiz en DB
    function saveQuizToDB(results){
      const uid = auth.currentUser.uid;
      const quiz = { results, date: Date.now() };
      const refQ = ref(db, 'quizz/'+uid+'/');
      get(refQ).then(snapshot=>{
        let arr = snapshot.exists() ? snapshot.val() : [];
        arr=Array.isArray(arr)?arr:[]; arr.push(quiz); set(refQ, arr);
      });
    }

    // ------------- Questionnaire avec BLANCS -------------
    function startWhiteQuiz(){
      // Génère questions
      let qs = [];
      for(let t=1; t<=12; t++)
        for(let i=1;i<=12;i++)
          qs.push({t,i, blank:Math.random()<.36 });
      content.innerHTML=`
        <h2 style="color:var(--accent);font-family:var(--font-title);">Complète les blancs</h2>
        <form id="whiteForm" class="glass" style="margin:34px auto;max-width:620px;padding:40px;">
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:18px;">
            ${qs.map((q,j)=>q.blank?
              `<input type="number" name="white${j}" style="font-size:1.04rem;padding:9px;border-radius:6px;" placeholder="${q.t} × ${q.i}" required="required"/>`
              : `<span style="padding:13px;font-size:1.13rem;color:var(--brique);">${q.t} × ${q.i} = <b>${q.t*q.i}</b></span>`
              ).join("")}
          </div>
          <button class="glass-btn" style="margin:auto;margin-top:24px;">Vérifier</button>
        </form>
      `;
      document.getElementById("whiteForm").onsubmit=(e)=>{
        e.preventDefault();
        // (Corrigé et données à pousser en suivi si tu veux)
        switchPage('apprentissage');
      };
    }

    // ------------ MODE CARTES ---------------
    let cardStack = [], cardIndex = 0, cardFlipped = false;
    function startCardMode(){
      // Build tous multiplications
      cardStack = [];
      for(let i=1;i<=12;i++) for(let j=1;j<=12;j++) cardStack.push([i,j]);
      cardStack = cardStack.sort(()=>Math.random()-.5); // shuffle
      cardIndex=0; cardFlipped=false;
      renderCard();
    }
    function renderCard(){
      let [a,b] = cardStack[cardIndex];
      content.innerHTML = `
        <div class="card-mode">
          <div class="flip-card ${cardFlipped?'flipped':''}" onclick="flipCard()">
            <div class="card-front">${a} × ${b}</div>
            <div class="card-back">${a*b}</div>
          </div>
          <div class="card-arrows">
            <button onclick="prevCard(event)">&lt;</button>
            <button onclick="nextCard(event)">&gt;</button>
          </div>
        </div>
      `;
    }
    window.flipCard = ()=>{cardFlipped=!cardFlipped; renderCard();};
    window.nextCard = (e)=>{ if(e) e.stopPropagation(); if(cardIndex<cardStack.length-1){cardIndex++;cardFlipped=false;renderCard();}};
    window.prevCard = (e)=>{ if(e) e.stopPropagation(); if(cardIndex>0){cardIndex--;cardFlipped=false;renderCard();}}

    // ------------- SUIVI / HISTO ------------ 
    function renderSuivi(){
      // Récupère les quizz DB user
      const uid = auth.currentUser.uid, refQ=ref(db,'quizz/'+uid+'/');
      get(refQ).then(snapshot=>{
        let quizz = snapshot.exists()?snapshot.val():[];
        quizz = Array.isArray(quizz)?quizz:[]; 
        let html = `<h1 style="color:var(--accent);font-size:2rem;">Suivi</h1>
        <div class="glass" style="margin:24px 0 34px 0;padding:37px 35px;">
          <div style="font-size:1.18rem;color:var(--accent);margin-bottom:13px;">Historique de vos quizz</div>
          <table style="width:100%;border-collapse:collapse;">
          <tr style="color:var(--accent);font-size:1.03rem;"><th>Date</th><th>Score</th><th>Sans faute</th></tr>
          `+quizz.map(q=>{
            let ok=q.results.filter(x=>x.ok&&!x.timeout).length, total=q.results.length;
            return `<tr style="text-align:center;color:var(--brique);">
              <td>${new Date(q.date).toLocaleString('fr-FR')}</td>
              <td><b>${ok} / ${total}</b></td>
              <td>${ok===total ? "✅" : ""}</td>
            </tr>`;
          }).reverse().join("")+`</table></div>`;
          // Stats rapides/Exemple stats-perf : à étoffer selon suivi réel
        html+=`
        <div class="glass" style="max-width:400px;margin:auto;padding:36px 20px;text-align:center;">
          <div style="font-size:1.4rem;font-family:var(--font-title);">Progression</div>
          <div style="font-size:3.2rem;color:var(--accent);margin:16px 0;">${calcPercentConnu(quizz)}%</div>
          <div style="color:var(--brique);">Pourcentage estimé des tables parfaitement maîtrisées (score parfait répété)</div>
        </div>
        `;
        content.innerHTML = html;
      });
    }
    // Estimation “table maîtrisée”
    function calcPercentConnu(quizz){
      // Ex: compte combien de fois par table tous résultats ok sur 5 sessions récentes
      // Pour prototype : si >=5/5 alors maîtrisée
      let tableStats = {};
      if(!quizz||!quizz.length) return 0;
      quizz = Array.isArray(quizz)?quizz:[]; // safety
      quizz.forEach(q=>{
        q.results.forEach(({q:[a,],ok})=>{
          if(!tableStats[a])tableStats[a]={ok:0,tot:0};
          tableStats[a].tot++; if(ok)tableStats[a].ok++;
        });
      });
      let countOk = 0, total=12;
      for(let i=1;i<=12;i++)
        if(tableStats[i] && tableStats[i].ok>=5) countOk++;
      return Math.round((countOk/total)*100);
    }

    // ----------- PARAMETRES -------------
    function renderParametres(){
      // Récupère settings utilisateur (userName...)
      const uid = auth.currentUser.uid, settingsRef=ref(db,'settings/'+uid+'/');
      get(settingsRef).then(snap=>{
        let sett = snap.exists()?snap.val():{userName:"", theme:"beige-brique"};
        let html = `
        <h1 style="color:var(--accent);font-size:2rem;">Paramètres</h1>
        <form id="paramForm" class="glass glass-form" style="max-width:410px;margin:auto;padding:37px 28px;">
        <div style="font-weight:bold;font-size:1.12rem;color:var(--accent);margin-bottom:16px;">Profil</div>
        <input type="text" id="setUserName" style="font-size:1.08rem;" placeholder="Nom d'utilisateur" value="${sett.userName||""}" />
        <div style="font-weight:bold;font-size:1.12rem;color:var(--accent);margin:17px 0 8px 0;">Apparence</div>
        <select id="setTheme" style="font-size:1.04rem;margin-bottom:20px;">
          <option value="beige-brique"${sett.theme==="beige-brique"?" selected":""}>Beige brique</option>
          <option value="classic">Classique</option>
        </select>
        <button class="glass-btn" type="submit">Enregistrer</button>
        </form>
        <div style="text-align:right;">
          <button class="glass-btn" style="margin-top:30px;background: #cfaca0;color:#a13700;" onclick="resetConfirm()">Réinitialiser la progression</button>
        </div>
        `;
        content.innerHTML = html;
        document.getElementById("paramForm").onsubmit=(e)=>{
          e.preventDefault();
          update(settingsRef, { userName: document.getElementById("setUserName").value, theme: document.getElementById("setTheme").value });
          switchPage("parametres");
        }
      });
    }
    window.resetConfirm = ()=>{
      showConfirm("Voulez-vous vraiment réinitialiser toute votre progression ? Cette action est irréversible.",
        ()=>{
          // Reset progression
          const uid = auth.currentUser.uid;
          set(ref(db,'quizz/'+uid+'/'),[]);
          set(ref(db,'settings/'+uid+'/'),{});
          switchPage('suivi');
        }
      );
    };

    function showConfirm(msg, yes){
      // Animation pop
      let box = document.getElementById("confirmBox");
      document.getElementById("confirmMsg").innerText = msg;
      box.style.display = "flex";
      document.getElementById("confirmYes").onclick = ()=>{ box.style.display="none"; yes(); };
      document.getElementById("confirmNo").onclick = ()=>{ box.style.display="none"; };
    }
    // INIT
    renderPage("tables");
  </script>
</body>
</html>
